# -*- coding: utf-8 -*-
"""LegalMate - ä¸­æ–‡æ³•å¾‹æ™ºèƒ½åŠ©æ‰‹.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1DJFULLPicf0_VJeu5tK8IbG5VxR-1dv-
"""

# ğŸ”§ Step 1: Install necessary libraries
!pip install -q sentence-transformers faiss-cpu openai gradio

# ğŸ“¦ Step 2: Import libraries
from sentence_transformers import SentenceTransformer
import numpy as np
import faiss
import gradio as gr
from transformers import pipeline

# ğŸ“ Step 3: Sample U.S. contract clauses (NDA)
legal_docs = [
    "Section 1: Purpose. The purpose of this Agreement is to establish a confidential relationship between the parties.",
    "Section 3: Confidential Information. Any non-public, proprietary, or confidential information disclosed by either party shall be treated as confidential.",
    "Section 5: Non-Disclosure Obligations. The Receiving Party agrees to hold the Disclosing Partyâ€™s Confidential Information in strict confidence and shall not disclose it to any third party.",
    "Section 9: Governing Law. This Agreement shall be governed by and construed in accordance with the laws of the State of California."
]

# ğŸ¤– Step 5: Encode clauses and build FAISS index
embedder = SentenceTransformer('all-MiniLM-L6-v2')
embeddings = embedder.encode(legal_docs)
dimension = embeddings.shape[1]
index = faiss.IndexFlatL2(dimension)
index.add(np.array(embeddings))

# ğŸ§  Step 5: å»ºç«‹ Hugging Face QA Pipelineï¼ˆä½¿ç”¨ flan-t5-baseï¼‰
qa_pipeline = pipeline("text2text-generation", model="google/flan-t5-large")

# ğŸ’¬ Step 6: å•ç­”å‡½å¼
def search_and_answer(user_question):
    try:
        # èªæ„æª¢ç´¢æœ€ç›¸é—œæ¢æ–‡
        query_vec = embedder.encode([user_question])
        _, indices = index.search(np.array(query_vec), k=1)
        matched_clause = legal_docs[indices[0][0]]

        # å»ºç«‹ prompt çµ¦ T5 æ¨¡å‹
        prompt = f"""You are a legal assistant for a U.S. law firm. Your job is to explain legal contract clauses in plain, professional English.

Given the following clause from a contract:

"{matched_clause}"

Please answer the question below using a full sentence and professional tone, as if you were helping a client understand the clause.

Question:
{user_question}

Answer:"""

        # ä½¿ç”¨ Hugging Face pipeline å›ç­”
        response = qa_pipeline(prompt, max_new_tokens=128, do_sample=False)[0]['generated_text']
        return f"ğŸ“„ Matched clause:\n{matched_clause}\n\nğŸ’¡ Answer:\n{response}"

    except Exception as e:
        return f"âŒ Error: {str(e)}"

# ğŸŒ Step 7: Gradio UI
gr.Interface(
    fn=search_and_answer,
    inputs=gr.Textbox(lines=2, label="Enter your legal question:"),
    outputs=gr.Textbox(label="AI Answer"),
    title="LegalMate â€“ AI Legal Assistant (Hugging Face Version)"
).launch(share=True, debug=True)
